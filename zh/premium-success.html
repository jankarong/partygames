<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级会员已激活 - PartyGameLab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/premium-success.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="../image/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="premium-success-container">
        <div class="premium-success-card">
            <div class="premium-icon-container">
                <div class="premium-icon-bg" id="iconContainer">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span class="checkmark" id="checkmark">✓</span>
                </div>
            </div>

            <h1 class="premium-title" id="pageTitle">感谢您！🎉</h1>
            <p class="premium-subtitle" id="pageSubtitle">您的高级会员正在激活中。我们正在验证您的支付信息。</p>

            <div class="progress-container" id="progressContainer" style="display:none;">
                <div class="progress-bar-custom">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
            </div>

            <div id="status" class="status-message" style="display:none;"></div>

            <div class="premium-features" id="features" style="display:none;">
                <h3>您的高级会员特权</h3>
                <div class="feature-item">
                    <div class="feature-icon">✓</div>
                    <div class="feature-text">完全无广告体验</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">✓</div>
                    <div class="feature-text">访问所有高级游戏</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">✓</div>
                    <div class="feature-text">优先客户支持</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">✓</div>
                    <div class="feature-text">独家功能和更新</div>
                </div>
            </div>

            <a href="./" class="btn-premium" id="homeButton" style="display:none;">返回主页</a>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/ads-controller.js"></script>
    <script>
        (async function () {
            const status = document.getElementById('status');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const checkmark = document.getElementById('checkmark');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const pageTitle = document.getElementById('pageTitle');
            const pageSubtitle = document.getElementById('pageSubtitle');
            const features = document.getElementById('features');
            const homeButton = document.getElementById('homeButton');

            // Show progress bar
            progressContainer.style.display = 'block';

            // Function to create confetti
            function createConfetti() {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        document.querySelector('.premium-success-card').appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 30);
                }
            }

            // Function to show success state
            function showSuccess() {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';

                // Show checkmark
                checkmark.classList.add('show');

                // Update title and subtitle
                pageTitle.textContent = '欢迎成为高级会员！🎉';
                pageSubtitle.textContent = '您的账户已成功升级。享受无广告体验吧！';

                // Update status
                status.style.display = 'block';
                status.className = 'status-message success';
                status.innerHTML = '<span>✓</span> 高级会员已激活。广告将不再显示。';

                // Show features
                features.style.display = 'block';

                // Show home button
                homeButton.style.display = 'inline-block';

                // Hide progress bar
                progressContainer.style.display = 'none';

                // Trigger confetti
                createConfetti();
            }

            // Function to update progress
            function updateProgress(percent) {
                progressBar.style.width = percent + '%';
            }

            // If we have session_id in URL, call confirm-session to force update
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const sid = urlParams.get('session_id');
                if (sid && window.supabaseClient) {
                    await window.supabaseClient.functions.invoke('confirm-session', {
                        method: 'POST',
                        body: { session_id: sid }
                    });
                }
            } catch (_) { }

            const start = Date.now();
            const maxDuration = 60000; // 60 seconds
            let attempts = 0;

            while (Date.now() - start < maxDuration) {
                try {
                    if (!window.authManager) break;

                    attempts++;
                    const elapsed = Date.now() - start;
                    const progress = Math.min((elapsed / maxDuration) * 100, 95);
                    updateProgress(progress);

                    const isPremium = await window.authManager.checkUserPremiumStatus();

                    if (isPremium) {
                        updateProgress(100);
                        showSuccess();
                        return;
                    }

                    // Update processing message
                    status.style.display = 'block';
                    status.className = 'status-message processing';
                    status.innerHTML = '<span>⏳</span> 正在验证您的支付... 通常只需几秒钟。';

                } catch (_) {
                    status.style.display = 'block';
                    status.className = 'status-message processing';
                    status.innerHTML = '<span>⏳</span> 等待验证中...';
                }

                await new Promise(r => setTimeout(r, 2000));
            }

            // Timeout message
            status.style.display = 'block';
            status.className = 'status-message warning';
            status.innerHTML = '<span>⚠</span> 仍在处理中。如果超过一分钟，请刷新页面或联系客服。';
            homeButton.style.display = 'inline-block';
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>

</html>
