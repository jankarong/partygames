<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Activated - PartyGameLab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./style/main.css" rel="stylesheet">
    <link href="./css/auth.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="image/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="image/partyGameLogo.png" alt="Party Games Logo" style="height:40px;width:auto;">
                <span class="brand-text">PartyGameLab</span>
            </a>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body p-4 text-center">
                        <h1 class="h3 mb-3">Thank you! ðŸŽ‰</h1>
                        <p class="text-muted">Your premium should be active shortly. We are verifying your payment.</p>

                        <div id="status" class="alert mt-3" style="display:none;"></div>

                        <a href="/" class="btn btn-primary mt-3">Back to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/auth.js"></script>
    <script src="/js/ads-controller.js"></script>
    <script>
        (async function () {
            const status = document.getElementById('status');
            status.style.display = 'block';
            // If we have session_id in URL, call confirm-session to force update
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const sid = urlParams.get('session_id');
                if (sid && window.supabaseClient) {
                    await window.supabaseClient.functions.invoke('confirm-session', {
                        method: 'POST',
                        body: { session_id: sid }
                    });
                }
            } catch (_) { }
            const start = Date.now();
            while (Date.now() - start < 60000) {
                try {
                    if (!window.authManager) break;
                    const isPremium = await window.authManager.checkUserPremiumStatus();
                    if (isPremium) {
                        status.className = 'alert alert-success';
                        status.textContent = 'Premium is active. Ads will no longer be shown.';
                        return;
                    }
                    status.className = 'alert alert-info';
                    status.textContent = 'Processing... Verifying your payment. This usually takes a few seconds.';
                } catch (_) {
                    status.className = 'alert alert-warning';
                    status.textContent = 'Waiting for verification...';
                }
                await new Promise(r => setTimeout(r, 2000));
            }
            status.className = 'alert alert-secondary';
            status.textContent = 'Still processing. If this takes more than a minute, please refresh the page.';
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>

</html>
